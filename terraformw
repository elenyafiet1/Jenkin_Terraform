@echo off
:: Windows batch version of tfswitch installation and terraform execution

echo Installing tfswitch locally

:: Download the installer
powershell -Command "Invoke-WebRequest -Uri 'https://raw.githubusercontent.com/warrensbox/terraform-switcher/release/install.sh' -OutFile 'install.sh'"

:: Make installer executable (not needed on Windows, but we'll run it with bash)
where bash >nul 2>&1
if %errorlevel% equ 0 (
    bash -c "chmod +x install.sh"
) else (
    echo WARNING: bash not found, proceeding without chmod
)

:: Install tfswitch in a local .bin directory
set CUSTOMBIN=%CD%\.bin
if not exist "%CUSTOMBIN%" mkdir "%CUSTOMBIN%"

:: Run the installer with bash
where bash >nul 2>&1
if %errorlevel% equ 0 (
    bash ./install.sh -b "%CUSTOMBIN%"
) else (
    echo ERROR: bash is required to run the installer
    exit /b 1
)

:: Add custom bin path to PATH environment
set PATH=%CUSTOMBIN%;%PATH%

:: Run tfswitch to select terraform version
"%CUSTOMBIN%\tfswitch" -b "%CUSTOMBIN%\terraform"

:: Run terraform with all passed arguments
terraform %*